From 1134723e96f6e2abcf8bfd7a2d1c96fcc323ef35 Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:13:56 +0100
Subject: [PATCH 04/44] [CVE-2009-0029] Remove __attribute__((weak)) from sys_pipe/sys_pipe2

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit 1134723e96f6e2abcf8bfd7a2d1c96fcc323ef35 upstream.

Remove __attribute__((weak)) from common code sys_pipe implemantation.
IA64, ALPHA, SUPERH (32bit) and SPARC (32bit) have own implemantations
with the same name. Just rename them.
For sys_pipe2 there is no architecture specific implementation.

Cc: Richard Henderson <rth@twiddle.net>
Cc: David S. Miller <davem@davemloft.net>
Cc: Paul Mundt <lethal@linux-sh.org>
Cc: Tony Luck <tony.luck@intel.com>
Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.24 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.24.orig/arch/alpha/kernel/entry.S linux-source-2.6.24/arch/alpha/kernel/entry.S
--- linux-source-2.6.24.orig/arch/alpha/kernel/entry.S	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/arch/alpha/kernel/entry.S	2009-01-21 00:29:42.000000000 -0700
@@ -894,9 +894,9 @@ sys_getxpid:
 .end sys_getxpid
 
 	.align	4
-	.globl	sys_pipe
-	.ent	sys_pipe
-sys_pipe:
+	.globl	sys_alpha_pipe
+	.ent	sys_alpha_pipe
+sys_alpha_pipe:
 	lda	$sp, -16($sp)
 	stq	$26, 0($sp)
 	.prologue 0
@@ -914,7 +914,7 @@ sys_pipe:
 	stq	$1, 80+16($sp)
 1:	lda	$sp, 16($sp)
 	ret
-.end sys_pipe
+.end sys_alpha_pipe
 
 	.align	4
 	.globl	sys_execve
diff -urpN linux-source-2.6.24.orig/arch/alpha/kernel/systbls.S linux-source-2.6.24/arch/alpha/kernel/systbls.S
--- linux-source-2.6.24.orig/arch/alpha/kernel/systbls.S	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/arch/alpha/kernel/systbls.S	2009-01-21 00:29:42.000000000 -0700
@@ -52,7 +52,7 @@ sys_call_table:
 	.quad sys_setpgid
 	.quad alpha_ni_syscall			/* 40 */
 	.quad sys_dup
-	.quad sys_pipe
+	.quad sys_alpha_pipe
 	.quad osf_set_program_attributes
 	.quad alpha_ni_syscall
 	.quad sys_open				/* 45 */
diff -urpN linux-source-2.6.24.orig/arch/ia64/ia32/ia32_entry.S linux-source-2.6.24/arch/ia64/ia32/ia32_entry.S
--- linux-source-2.6.24.orig/arch/ia64/ia32/ia32_entry.S	2009-01-21 00:15:40.000000000 -0700
+++ linux-source-2.6.24/arch/ia64/ia32/ia32_entry.S	2009-01-21 00:29:42.000000000 -0700
@@ -215,7 +215,7 @@ ia32_syscall_table:
 	data8 sys_mkdir
 	data8 sys_rmdir		  /* 40 */
 	data8 sys_dup
-	data8 sys_pipe
+	data8 sys_ia64_pipe
 	data8 compat_sys_times
 	data8 sys_ni_syscall	  /* old prof syscall holder */
 	data8 sys32_brk		  /* 45 */
diff -urpN linux-source-2.6.24.orig/arch/ia64/kernel/entry.S linux-source-2.6.24/arch/ia64/kernel/entry.S
--- linux-source-2.6.24.orig/arch/ia64/kernel/entry.S	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/arch/ia64/kernel/entry.S	2009-01-21 00:29:42.000000000 -0700
@@ -1336,7 +1336,7 @@ sys_call_table:
 	data8 sys_mkdir				// 1055
 	data8 sys_rmdir
 	data8 sys_dup
-	data8 sys_pipe
+	data8 sys_ia64_pipe
 	data8 sys_times
 	data8 ia64_brk				// 1060
 	data8 sys_setgid
diff -urpN linux-source-2.6.24.orig/arch/ia64/kernel/sys_ia64.c linux-source-2.6.24/arch/ia64/kernel/sys_ia64.c
--- linux-source-2.6.24.orig/arch/ia64/kernel/sys_ia64.c	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/arch/ia64/kernel/sys_ia64.c	2009-01-21 00:29:42.000000000 -0700
@@ -154,7 +154,7 @@ out:
  * and r9) as this is faster than doing a copy_to_user().
  */
 asmlinkage long
-sys_pipe (void)
+sys_ia64_pipe (void)
 {
 	struct pt_regs *regs = task_pt_regs(current);
 	int fd[2];
diff -urpN linux-source-2.6.24.orig/arch/sparc/kernel/entry.S linux-source-2.6.24/arch/sparc/kernel/entry.S
--- linux-source-2.6.24.orig/arch/sparc/kernel/entry.S	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/arch/sparc/kernel/entry.S	2009-01-21 00:29:55.000000000 -0700
@@ -1250,8 +1250,8 @@ sys_execve:
 	 mov	%l5, %o7
 
 	.align	4
-	.globl	sys_pipe
-sys_pipe:
+	.globl	sys_sparc_pipe
+sys_sparc_pipe:
 	mov	%o7, %l5
 	add	%sp, STACKFRAME_SZ, %o0		! pt_regs *regs arg
 	call	sparc_pipe
diff -urpN linux-source-2.6.24.orig/arch/sparc/kernel/systbls.S linux-source-2.6.24/arch/sparc/kernel/systbls.S
--- linux-source-2.6.24.orig/arch/sparc/kernel/systbls.S	2009-01-21 00:13:05.000000000 -0700
+++ linux-source-2.6.24/arch/sparc/kernel/systbls.S	2009-01-21 00:29:55.000000000 -0700
@@ -24,7 +24,7 @@ sys_call_table:
 /*25*/	.long sys_vmsplice, sys_ptrace, sys_alarm, sys_sigaltstack, sys_pause
 /*30*/	.long sys_utime, sys_lchown, sys_fchown, sys_access, sys_nice
 /*35*/	.long sys_chown, sys_sync, sys_kill, sys_newstat, sys_sendfile
-/*40*/	.long sys_newlstat, sys_dup, sys_pipe, sys_times, sys_getuid
+/*40*/	.long sys_newlstat, sys_dup, sys_sparc_pipe, sys_times, sys_getuid
 /*45*/	.long sys_umount, sys_setgid16, sys_getgid16, sys_signal, sys_geteuid16
 /*50*/	.long sys_getegid16, sys_acct, sys_nis_syscall, sys_getgid, sys_ioctl
 /*55*/	.long sys_reboot, sys_mmap2, sys_symlink, sys_readlink, sys_execve
diff -urpN linux-source-2.6.24.orig/arch/sparc64/kernel/systbls.S linux-source-2.6.24/arch/sparc64/kernel/systbls.S
--- linux-source-2.6.24.orig/arch/sparc64/kernel/systbls.S	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/arch/sparc64/kernel/systbls.S	2009-01-21 00:29:57.000000000 -0700
@@ -26,7 +26,7 @@ sys_call_table32:
 /*25*/	.word sys32_vmsplice, sys_ptrace, sys_alarm, sys32_sigaltstack, sys32_pause
 /*30*/	.word compat_sys_utime, sys_lchown, sys_fchown, sys32_access, sys32_nice
 	.word sys_chown, sys_sync, sys32_kill, compat_sys_newstat, sys32_sendfile
-/*40*/	.word compat_sys_newlstat, sys_dup, sys_pipe, compat_sys_times, sys_getuid
+/*40*/	.word compat_sys_newlstat, sys_dup, sys_sparc_pipe, compat_sys_times, sys_getuid
 	.word sys32_umount, sys32_setgid16, sys32_getgid16, sys32_signal, sys32_geteuid16
 /*50*/	.word sys32_getegid16, sys_acct, sys_nis_syscall, sys_getgid, compat_sys_ioctl
 	.word sys32_reboot, sys32_mmap2, sys_symlink, sys32_readlink, sys32_execve
@@ -98,7 +98,7 @@ sys_call_table:
 /*25*/	.word sys_vmsplice, sys_ptrace, sys_alarm, sys_sigaltstack, sys_nis_syscall
 /*30*/	.word sys_utime, sys_nis_syscall, sys_nis_syscall, sys_access, sys_nice
 	.word sys_nis_syscall, sys_sync, sys_kill, sys_newstat, sys_sendfile64
-/*40*/	.word sys_newlstat, sys_dup, sys_pipe, sys_times, sys_nis_syscall
+/*40*/	.word sys_newlstat, sys_dup, sys_sparc_pipe, sys_times, sys_nis_syscall
 	.word sys_umount, sys_setgid, sys_getgid, sys_signal, sys_geteuid
 /*50*/	.word sys_getegid, sys_acct, sys_memory_ordering, sys_nis_syscall, sys_ioctl
 	.word sys_reboot, sys_nis_syscall, sys_symlink, sys_readlink, sys_execve
diff -urpN linux-source-2.6.24.orig/fs/pipe.c linux-source-2.6.24/fs/pipe.c
--- linux-source-2.6.24.orig/fs/pipe.c	2009-01-21 00:27:52.000000000 -0700
+++ linux-source-2.6.24/fs/pipe.c	2009-01-21 00:29:57.000000000 -0700
@@ -1079,7 +1079,7 @@ int do_pipe(int *fd)
  * sys_pipe() is the normal C calling standard for creating
  * a pipe. It's not the way Unix traditionally does this, though.
  */
-asmlinkage long __weak sys_pipe(int __user *fildes)
+asmlinkage long sys_pipe(int __user *fildes)
 {
 	int fd[2];
 	int error;
diff -urpN linux-source-2.6.24.orig/include/asm-ia64/unistd.h linux-source-2.6.24/include/asm-ia64/unistd.h
--- linux-source-2.6.24.orig/include/asm-ia64/unistd.h	2008-01-24 15:58:37.000000000 -0700
+++ linux-source-2.6.24/include/asm-ia64/unistd.h	2009-01-21 00:29:57.000000000 -0700
@@ -354,7 +354,7 @@ struct pt_regs;
 struct sigaction;
 long sys_execve(char __user *filename, char __user * __user *argv,
 			   char __user * __user *envp, struct pt_regs *regs);
-asmlinkage long sys_pipe(void);
+asmlinkage long sys_ia64_pipe(void);
 asmlinkage long sys_rt_sigaction(int sig,
 				 const struct sigaction __user *act,
 				 struct sigaction __user *oact,
diff -urpN a/arch/sparc64/kernel/systbls.S b/arch/sparc64/kernel/systbls.S
--- a/arch/sparc64/kernel/systbls.S	2009-02-16 12:51:13.000000000 -0700
+++ b/arch/sparc64/kernel/systbls.S	2009-02-16 12:51:52.000000000 -0700
@@ -175,7 +175,7 @@ sunos_sys_table:
 	.word sys_access, sunos_nosys, sunos_nosys
 	.word sys_sync, sys_kill, compat_sys_newstat
 	.word sunos_nosys, compat_sys_newlstat, sys_dup
-	.word sys_pipe, sunos_nosys, sunos_nosys
+	.word sys_sparc_pipe, sunos_nosys, sunos_nosys
 	.word sunos_nosys, sunos_nosys, sunos_getgid
 	.word sunos_nosys, sunos_nosys
 /*50*/	.word sunos_nosys, sys_acct, sunos_nosys
