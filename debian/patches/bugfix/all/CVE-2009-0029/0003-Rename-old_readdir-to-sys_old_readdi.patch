From e55380edf68796d75bf41391a781c68ee678587d Mon Sep 17 00:00:00 2001
From: Heiko Carstens <heiko.carstens@de.ibm.com>
Date: Wed, 14 Jan 2009 14:13:55 +0100
Subject: [PATCH 03/44] [CVE-2009-0029] Rename old_readdir to sys_old_readdir

From: Heiko Carstens <heiko.carstens@de.ibm.com>

commit e55380edf68796d75bf41391a781c68ee678587d upstream.

This way it matches the generic system call name convention.

Signed-off-by: Heiko Carstens <heiko.carstens@de.ibm.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

Backported to Debian's 2.6.26 by dann frazier <dannf@debian.org>

diff -urpN linux-source-2.6.26.orig/arch/arm/kernel/calls.S linux-source-2.6.26/arch/arm/kernel/calls.S
--- linux-source-2.6.26.orig/arch/arm/kernel/calls.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/arm/kernel/calls.S	2009-01-19 11:16:52.000000000 -0700
@@ -98,7 +98,7 @@
 		CALL(sys_uselib)
 		CALL(sys_swapon)
 		CALL(sys_reboot)
-		CALL(OBSOLETE(old_readdir))	/* used by libc4 */
+		CALL(OBSOLETE(sys_old_readdir))	/* used by libc4 */
 /* 90 */	CALL(OBSOLETE(old_mmap))	/* used by libc4 */
 		CALL(sys_munmap)
 		CALL(sys_truncate)
diff -urpN linux-source-2.6.26.orig/arch/cris/arch-v10/kernel/entry.S linux-source-2.6.26/arch/cris/arch-v10/kernel/entry.S
--- linux-source-2.6.26.orig/arch/cris/arch-v10/kernel/entry.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/cris/arch-v10/kernel/entry.S	2009-01-19 11:16:52.000000000 -0700
@@ -691,7 +691,7 @@ sys_call_table:	
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/cris/arch-v32/kernel/entry.S linux-source-2.6.26/arch/cris/arch-v32/kernel/entry.S
--- linux-source-2.6.26.orig/arch/cris/arch-v32/kernel/entry.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/cris/arch-v32/kernel/entry.S	2009-01-19 11:16:52.000000000 -0700
@@ -614,7 +614,7 @@ sys_call_table:
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/h8300/kernel/syscalls.S linux-source-2.6.26/arch/h8300/kernel/syscalls.S
--- linux-source-2.6.26.orig/arch/h8300/kernel/syscalls.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/h8300/kernel/syscalls.S	2009-01-19 11:16:52.000000000 -0700
@@ -103,7 +103,7 @@ SYMBOL_NAME_LABEL(sys_call_table)	
 	.long SYMBOL_NAME(sys_uselib)
 	.long SYMBOL_NAME(sys_swapon)
 	.long SYMBOL_NAME(sys_reboot)
-	.long SYMBOL_NAME(old_readdir)
+	.long SYMBOL_NAME(sys_old_readdir)
 	.long SYMBOL_NAME(old_mmap)		/* 90 */
 	.long SYMBOL_NAME(sys_munmap)
 	.long SYMBOL_NAME(sys_truncate)
diff -urpN linux-source-2.6.26.orig/arch/m68k/kernel/entry.S linux-source-2.6.26/arch/m68k/kernel/entry.S
--- linux-source-2.6.26.orig/arch/m68k/kernel/entry.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/m68k/kernel/entry.S	2009-01-19 11:16:52.000000000 -0700
@@ -513,7 +513,7 @@ sys_call_table:
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/m68knommu/kernel/syscalltable.S linux-source-2.6.26/arch/m68knommu/kernel/syscalltable.S
--- linux-source-2.6.26.orig/arch/m68knommu/kernel/syscalltable.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/m68knommu/kernel/syscalltable.S	2009-01-19 11:16:52.000000000 -0700
@@ -107,7 +107,7 @@ ENTRY(sys_call_table)
 	.long sys_uselib
 	.long sys_ni_syscall	/* sys_swapon */
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/mips/kernel/scall32-o32.S linux-source-2.6.26/arch/mips/kernel/scall32-o32.S
--- linux-source-2.6.26.orig/arch/mips/kernel/scall32-o32.S	2009-01-10 05:42:16.000000000 -0700
+++ linux-source-2.6.26/arch/mips/kernel/scall32-o32.S	2009-01-19 11:16:52.000000000 -0700
@@ -413,7 +413,7 @@ einval:	li	v0, -EINVAL
 	sys	sys_uselib		1
 	sys	sys_swapon		2
 	sys	sys_reboot		3
-	sys	old_readdir		3
+	sys	sys_old_readdir		3
 	sys	old_mmap		6	/* 4090 */
 	sys	sys_munmap		2
 	sys	sys_truncate		2
diff -urpN linux-source-2.6.26.orig/arch/mn10300/kernel/entry.S linux-source-2.6.26/arch/mn10300/kernel/entry.S
--- linux-source-2.6.26.orig/arch/mn10300/kernel/entry.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/mn10300/kernel/entry.S	2009-01-19 11:16:52.000000000 -0700
@@ -477,7 +477,7 @@ ENTRY(sys_call_table)
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/sh/kernel/syscalls_32.S linux-source-2.6.26/arch/sh/kernel/syscalls_32.S
--- linux-source-2.6.26.orig/arch/sh/kernel/syscalls_32.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/sh/kernel/syscalls_32.S	2009-01-19 11:17:08.000000000 -0700
@@ -105,7 +105,7 @@ ENTRY(sys_call_table)
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/sh/kernel/syscalls_64.S linux-source-2.6.26/arch/sh/kernel/syscalls_64.S
--- linux-source-2.6.26.orig/arch/sh/kernel/syscalls_64.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/sh/kernel/syscalls_64.S	2009-01-19 11:17:08.000000000 -0700
@@ -109,7 +109,7 @@ sys_call_table:
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap			/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/arch/sparc/kernel/systbls.S linux-source-2.6.26/arch/sparc/kernel/systbls.S
--- linux-source-2.6.26.orig/arch/sparc/kernel/systbls.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/sparc/kernel/systbls.S	2009-01-19 11:17:08.000000000 -0700
@@ -56,7 +56,7 @@ sys_call_table:
 /*185*/	.long sys_setpgid, sys_fremovexattr, sys_tkill, sys_exit_group, sys_newuname
 /*190*/	.long sys_init_module, sys_personality, sparc_remap_file_pages, sys_epoll_create, sys_epoll_ctl
 /*195*/	.long sys_epoll_wait, sys_ioprio_set, sys_getppid, sparc_sigaction, sys_sgetmask
-/*200*/	.long sys_ssetmask, sys_sigsuspend, sys_newlstat, sys_uselib, old_readdir
+/*200*/	.long sys_ssetmask, sys_sigsuspend, sys_newlstat, sys_uselib, sys_old_readdir
 /*205*/	.long sys_readahead, sys_socketcall, sys_syslog, sys_lookup_dcookie, sys_fadvise64
 /*210*/	.long sys_fadvise64_64, sys_tgkill, sys_waitpid, sys_swapoff, sys_sysinfo
 /*215*/	.long sys_ipc, sys_sigreturn, sys_clone, sys_ioprio_get, sys_adjtimex
diff -urpN linux-source-2.6.26.orig/arch/x86/kernel/syscall_table_32.S linux-source-2.6.26/arch/x86/kernel/syscall_table_32.S
--- linux-source-2.6.26.orig/arch/x86/kernel/syscall_table_32.S	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/arch/x86/kernel/syscall_table_32.S	2009-01-19 11:17:08.000000000 -0700
@@ -88,7 +88,7 @@ ENTRY(sys_call_table)
 	.long sys_uselib
 	.long sys_swapon
 	.long sys_reboot
-	.long old_readdir
+	.long sys_old_readdir
 	.long old_mmap		/* 90 */
 	.long sys_munmap
 	.long sys_truncate
diff -urpN linux-source-2.6.26.orig/fs/readdir.c linux-source-2.6.26/fs/readdir.c
--- linux-source-2.6.26.orig/fs/readdir.c	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/fs/readdir.c	2009-01-19 11:17:08.000000000 -0700
@@ -100,7 +100,7 @@ efault:
 	return -EFAULT;
 }
 
-asmlinkage long old_readdir(unsigned int fd, struct old_linux_dirent __user * dirent, unsigned int count)
+asmlinkage long sys_old_readdir(unsigned int fd, struct old_linux_dirent __user * dirent, unsigned int count)
 {
 	int error;
 	struct file * file;
diff -urpN linux-source-2.6.26.orig/include/asm-powerpc/systbl.h linux-source-2.6.26/include/asm-powerpc/systbl.h
--- linux-source-2.6.26.orig/include/asm-powerpc/systbl.h	2008-07-13 15:51:29.000000000 -0600
+++ linux-source-2.6.26/include/asm-powerpc/systbl.h	2009-01-19 11:18:35.000000000 -0700
@@ -92,7 +92,7 @@ COMPAT_SYS_SPU(readlink)
 SYSCALL(uselib)
 SYSCALL(swapon)
 SYSCALL(reboot)
-SYSX(sys_ni_syscall,old32_readdir,old_readdir)
+SYSX(sys_ni_syscall,old32_readdir,sys_old_readdir)
 SYSCALL_SPU(mmap)
 SYSCALL_SPU(munmap)
 SYSCALL_SPU(truncate)
diff -urpN linux-source-2.6.26.orig/include/linux/syscalls.h linux-source-2.6.26/include/linux/syscalls.h
--- linux-source-2.6.26.orig/include/linux/syscalls.h	2009-01-19 11:12:44.000000000 -0700
+++ linux-source-2.6.26/include/linux/syscalls.h	2009-01-19 11:17:08.000000000 -0700
@@ -54,6 +54,7 @@ struct compat_stat;
 struct compat_timeval;
 struct robust_list_head;
 struct getcpu_cache;
+struct old_linux_dirent;
 
 #include <linux/types.h>
 #include <linux/aio_abi.h>
@@ -602,6 +603,7 @@ asmlinkage long sys_timerfd_settime(int 
 asmlinkage long sys_timerfd_gettime(int ufd, struct itimerspec __user *otmr);
 asmlinkage long sys_eventfd(unsigned int count);
 asmlinkage long sys_fallocate(int fd, int mode, loff_t offset, loff_t len);
+asmlinkage long sys_old_readdir(unsigned int, struct old_linux_dirent __user *, unsigned int);
 
 int kernel_execve(const char *filename, char *const argv[], char *const envp[]);
 
