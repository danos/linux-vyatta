tun: add ioctl to set permanent hardware address

Provide an interface for userspace to set the permanent hardware
address on tun interfaces.

Signed-off-by: "Charles (Chas) Williams" <ciwillia@vyatta.att-mail.com>

---
 drivers/net/tun.c           |   12 +++++++++++-
 include/uapi/linux/if_tun.h |    2 ++
 2 files changed, 13 insertions(+), 1 deletion(-)

--- a/drivers/net/tun.c
+++ b/drivers/net/tun.c
@@ -2910,7 +2910,7 @@ static long __tun_chr_ioctl(struct file
 	int ret;
 	bool do_notify = false;
 
-	if (cmd == TUNSETIFF || cmd == TUNSETQUEUE ||
+	if (cmd == TUNSETIFF || cmd == TUNSETQUEUE || cmd == TUNSETPERMADDR ||
 	    (_IOC_TYPE(cmd) == SOCK_IOC_TYPE && cmd != SIOCGSKNS)) {
 		if (copy_from_user(&ifr, argp, ifreq_len))
 			return -EFAULT;
@@ -3193,6 +3193,15 @@ static long __tun_chr_ioctl(struct file
 		ret = tun_set_ebpf(tun, &tun->filter_prog, argp);
 		break;
 
+	case TUNSETPERMADDR:
+		/* Set permanent hw address */
+		tun_debug(KERN_DEBUG, tun, "set perm hw address: %pM\n",
+			  ifr.ifr_hwaddr.sa_data);
+
+		ether_addr_copy(tun->dev->perm_addr, ifr.ifr_hwaddr.sa_data);
+		ret = 0;
+		break;
+
 	default:
 		ret = -EINVAL;
 		break;
--- a/include/uapi/linux/if_tun.h
+++ b/include/uapi/linux/if_tun.h
@@ -60,6 +60,8 @@
 #define TUNSETSTEERINGEBPF _IOR('T', 224, int)
 #define TUNSETFILTEREBPF _IOR('T', 225, int)
 
+#define TUNSETPERMADDR _IOW('T', 230, struct ifreq)
+
 /* TUNSETIFF ifr flags */
 #define IFF_TUN		0x0001
 #define IFF_TAP		0x0002
